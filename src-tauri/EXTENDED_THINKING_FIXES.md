# Extended Thinking - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫

**–î–∞—Ç–∞**: 2026-01-09
**–í–µ—Ä—Å–∏—è**: v3.3.20

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Extended Thinking –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏—è.

---

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–ü—Ä–æ–±–ª–µ–º–∞ #1: effortLevel - –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä](#–ø—Ä–æ–±–ª–µ–º–∞-1-effortlevel)
2. [–ü—Ä–æ–±–ª–µ–º–∞ #2: Corrupted thought signature](#–ø—Ä–æ–±–ª–µ–º–∞-2-corrupted-thought-signature)
3. [–ü—Ä–æ–±–ª–µ–º–∞ #3: Claude Opus Thinking timeout](#–ø—Ä–æ–±–ª–µ–º–∞-3-claude-opus-thinking-timeout)
4. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Ä–µ—à–µ–Ω–∏—è)
5. [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)

---

## –ü—Ä–æ–±–ª–µ–º–∞ #1: effortLevel

### üî¥ –°–∏–º–ø—Ç–æ–º—ã

```json
{
  "error": {
    "code": 400,
    "message": "Invalid JSON payload received. Unknown name \"effortLevel\" at 'request.generation_config': Cannot find field.",
    "status": "INVALID_ARGUMENT"
  }
}
```

**–ö–æ–≥–¥–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç:**
- –ö–ª–∏–µ–Ω—Ç (OpenCode, Claude Code, Cursor) –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `output_config.effort`
- Proxy –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∑–∞–ø—Ä–æ—Å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Google API
- Google API –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å —Å –æ—à–∏–±–∫–æ–π 400

### üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏—á–∏–Ω

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ:**

Google –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–≤–∞ —Ä–∞–∑–Ω—ã—Ö API –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –º–æ–¥–µ–ª—è–º Claude/Gemini:

1. **Native Gemini API** (`generativelanguage.googleapis.com`)
   - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `effortLevel` –≤ `generationConfig`
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏ Google (AI Studio, NotebookLM)

2. **Cloud Code API v1internal** (`cloudcode-pa.googleapis.com`)
   - **–ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç** `effortLevel`
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ Google OAuth —Ç–æ–∫–µ–Ω—ã (–Ω–∞—à —Å–ª—É—á–∞–π)
   - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç: `temperature`, `topP`, `topK`, `maxOutputTokens`, `thinkingConfig`

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ –∫–æ–¥–µ:**

```rust
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (—Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è)
if let Some(effort) = &output_config.effort {
    config["effortLevel"] = json!(effort);  // Google Cloud Code API –Ω–µ –∑–Ω–∞–µ—Ç —ç—Ç–æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä!
}
```

### ‚úÖ –†–µ—à–µ–Ω–∏–µ

**–ö–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω—ã–π mapping:**

`effortLevel` –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –≤—ã–≤–æ–¥–∞ –º–æ–¥–µ–ª–∏. –í–º–µ—Å—Ç–æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π `temperature`:

| effort | temperature | –ü–æ–≤–µ–¥–µ–Ω–∏–µ |
|--------|-------------|-----------|
| `high` | `0.3` | –ë–æ–ª–µ–µ —Ç–æ—á–Ω—ã–µ, –¥–µ—Ç–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–Ω–∏–∑–∫–∞—è –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å) |
| `medium` | `0.7` | –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º (—É–º–µ—Ä–µ–Ω–Ω–∞—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å) |
| `low` | `1.0` | –ë—ã—Å—Ç—Ä—ã–µ, –º–µ–Ω–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–≤—ã—Å–æ–∫–∞—è –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å) |

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```rust
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û (–Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è)
// –§–∞–π–ª: src-tauri/src/proxy/mappers/claude/request.rs
// –°—Ç—Ä–æ–∫–∏: 1041-1070

if let Some(output_config) = &claude_req.output_config {
    if let Some(effort) = &output_config.effort {
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–¥–∞–ª temperature —è–≤–Ω–æ
        if claude_req.temperature.is_none() {
            let temperature = match effort.to_lowercase().as_str() {
                "high" => 0.3,    // –¢–æ—á–Ω–æ—Å—Ç—å, –¥–µ—Ç–∞–ª—å–Ω–æ—Å—Ç—å
                "medium" => 0.7,  // –ë–∞–ª–∞–Ω—Å
                "low" => 1.0,     // –°–∫–æ—Ä–æ—Å—Ç—å
                _ => 0.7          // Default: balanced
            };
            config["temperature"] = json!(temperature);

            tracing::debug!(
                "[Generation-Config] Effort level mapped to temperature: {} -> {}",
                effort,
                temperature
            );
        } else {
            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π temperature –≤–∞–∂–Ω–µ–µ
            tracing::debug!(
                "[Generation-Config] User-specified temperature takes precedence over effort level"
            );
        }
    }
}
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:**
1. –Ø–≤–Ω–æ –∑–∞–¥–∞–Ω–Ω—ã–π `temperature` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å
2. `effort` –±–µ–∑ `temperature` ‚Üí –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç—Å—è –≤ `temperature`
3. –ù–∏ —Ç–æ–≥–æ, –Ω–∏ –¥—Ä—É–≥–æ–≥–æ ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏

### üìä –†–µ–∑—É–ª—å—Ç–∞—Ç

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚ùå 100% –∑–∞–ø—Ä–æ—Å–æ–≤ —Å `effort` –≤–æ–∑–≤—Ä–∞—â–∞–ª–∏ 400 –æ—à–∏–±–∫—É
- ‚ùå –ö–ª–∏–µ–Ω—Ç—ã –Ω–µ –º–æ–≥–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `output_config.effort`

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚úÖ 100% —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä `effort` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ `temperature` mapping
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —Å–µ–º–∞–Ω—Ç–∏–∫–∞: high effort = –±–æ–ª–µ–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã

**–ò—Å—Ç–æ—á–Ω–∏–∫–∏:**
- [Google Cloud GenerationConfig](https://cloud.google.com/vertex-ai/generative-ai/docs/reference/rest/v1beta1/GenerationConfig)
- [Content Generation Parameters](https://cloud.google.com/vertex-ai/generative-ai/docs/multimodal/content-generation-parameters)

---

## –ü—Ä–æ–±–ª–µ–º–∞ #2: Corrupted thought signature

### üî¥ –°–∏–º–ø—Ç–æ–º—ã

```json
{
  "error": {
    "code": 400,
    "message": "Corrupted thought signature.",
    "status": "INVALID_ARGUMENT"
  }
}
```

**–ö–æ–≥–¥–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç:**
- –ó–∞–ø—Ä–æ—Å —Å–æ–¥–µ—Ä–∂–∏—Ç thinking blocks –≤ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- Google API –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—É—é signature –≤ thinking –±–ª–æ–∫–µ
- –ó–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π 400

### üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏—á–∏–Ω

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ –ª–æ–≥–∏–∫–µ retry:**

–°–∏—Å—Ç–µ–º–∞ —É–∂–µ –∏–º–µ–ª–∞ –º–µ—Ö–∞–Ω–∏–∑–º –æ–±—Ä–∞–±–æ—Ç–∫–∏ thinking signature –æ—à–∏–±–æ–∫:

1. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è (—Å—Ç—Ä–æ–∫–∏ 771-822 –≤ `claude.rs`):**
   ```rust
   if status_code == 400 && !retried_without_thinking
       && (error_text.contains("Invalid `signature`")
           || error_text.contains("thinking.signature")
           || error_text.contains("thinking.thinking")
           // ...–Ω–æ –ù–ï–¢ –ø—Ä–æ–≤–µ—Ä–∫–∏ "Corrupted thought signature"!
   ```

2. **Retry strategy (—Å—Ç—Ä–æ–∫–∏ 182-231 –≤ `claude.rs`):**
   ```rust
   fn determine_retry_strategy(status_code: u16, error_text: &str, ...) {
       match status_code {
           400 if !retried_without_thinking
               && (error_text.contains("Invalid `signature`")
                   || error_text.contains("thinking.signature")
                   // ...—Å–Ω–æ–≤–∞ –ù–ï–¢ "Corrupted thought signature"!
   ```

**–ü–æ—á–µ–º—É –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–æ:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ **—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏** (—Å—Ç—Ä–æ–∫–∞ 779) –≤–∫–ª—é—á–∞–ª–∞ `"Corrupted thought signature"` ‚úÖ
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ **retry strategy** (—Å—Ç—Ä–æ–∫–∏ 189-192) –ù–ï –≤–∫–ª—é—á–∞–ª–∞ ‚ùå
- –†–µ–∑—É–ª—å—Ç–∞—Ç: —Å–∏—Å—Ç–µ–º–∞ –ø—ã—Ç–∞–ª–∞—Å—å –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å, –Ω–æ `determine_retry_strategy()` –≤–æ–∑–≤—Ä–∞—â–∞–ª–∞ `RetryStrategy::NoRetry`
- –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–ª 400 –æ—à–∏–±–∫—É –≤–º–µ—Å—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ retry

### ‚úÖ –†–µ—à–µ–Ω–∏–µ

**–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —É—Å–ª–æ–≤–∏–π:**

```rust
// –§–∞–π–ª: src-tauri/src/proxy/handlers/claude.rs
// –°—Ç—Ä–æ–∫–∏: 189-198

fn determine_retry_strategy(
    status_code: u16,
    error_text: &str,
    retried_without_thinking: bool,
) -> RetryStrategy {
    match status_code {
        // 400 –æ—à–∏–±–∫–∞: Thinking signature –æ—à–∏–±–∫–∏
        400 if !retried_without_thinking
            && (error_text.contains("Invalid `signature`")
                || error_text.contains("thinking.signature")
                || error_text.contains("thinking.thinking")
                || error_text.contains("Corrupted thought signature")  // ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
                || error_text.contains("INVALID_ARGUMENT")) =>        // ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
        {
            // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ 200ms –ø–µ—Ä–µ–¥ retry
            RetryStrategy::FixedDelay(Duration::from_millis(200))
        }
```

### üîÑ –ê–ª–≥–æ—Ä–∏—Ç–º –æ–±—Ä–∞–±–æ—Ç–∫–∏

**–ü–æ–ª–Ω—ã–π flow –ø—Ä–∏ "Corrupted thought signature" –æ—à–∏–±–∫–µ:**

```mermaid
graph TD
    A[–ó–∞–ø—Ä–æ—Å —Å thinking blocks] --> B[–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Google API]
    B --> C{–û—Ç–≤–µ—Ç 400?}
    C -->|–î–∞| D{–°–æ–¥–µ—Ä–∂–∏—Ç 'Corrupted thought signature'?}
    C -->|–ù–µ—Ç| Z[–£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç]

    D -->|–î–∞| E{retried_without_thinking = false?}
    D -->|–ù–µ—Ç| F[–î—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞]

    E -->|–î–∞| G[determine_retry_strategy]
    E -->|–ù–µ—Ç| H[–í–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–∫–∏ –∫–ª–∏–µ–Ω—Ç—É]

    G --> I[RetryStrategy::FixedDelay 200ms]
    I --> J[–ó–∞–¥–µ—Ä–∂–∫–∞ 200ms]
    J --> K[–£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö thinking blocks]
    K --> L[–û—á–∏—Å—Ç–∫–∞ -thinking —Å—É—Ñ—Ñ–∏–∫—Å–∞]
    L --> M[retried_without_thinking = true]
    M --> N[–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞]
    N --> B

    F --> H
```

**–ü–æ—à–∞–≥–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:**

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—à–∏–±–∫–∏** (—Å—Ç—Ä–æ–∫–∏ 754-762)
   - –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å 400 –æ—Ç Google API
   - –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
   - –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ retry —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏** (—Å—Ç—Ä–æ–∫–∏ 830)
   - `determine_retry_strategy()` –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É
   - –û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç "Corrupted thought signature"
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `FixedDelay(200ms)`

3. **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ retry** (—Å—Ç—Ä–æ–∫–∏ 819-822)
   - `apply_retry_strategy()` –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∑–∞–¥–µ—Ä–∂–∫—É
   - –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ü–∏–∫–ª (`continue`)

4. **–û—á–∏—Å—Ç–∫–∞ thinking** (—Å—Ç—Ä–æ–∫–∏ 792-815)
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º `retried_without_thinking = true`
   - –£–¥–∞–ª—è–µ–º `request.thinking`
   - –û—á–∏—â–∞–µ–º –≤—Å–µ `ThinkingBlock` –∏ `RedactedThinking` –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
   - –£–±–∏—Ä–∞–µ–º `-thinking` —Å—É—Ñ—Ñ–∏–∫—Å –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –º–æ–¥–µ–ª–∏

5. **–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞**
   - –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–Ω–æ–≤–∞
   - –ë–µ–∑ thinking blocks ‚Üí —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç

### üìä –†–µ–∑—É–ª—å—Ç–∞—Ç

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚ùå –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–ª 400 "Corrupted thought signature"
- ‚ùå Retry –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª –∏–∑-–∑–∞ –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–æ–∫
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–µ–ª –æ—à–∏–±–∫—É –≤–º–µ—Å—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 200ms
- ‚úÖ Thinking blocks —É–¥–∞–ª—è—é—Ç—Å—è –∏ –∑–∞–ø—Ä–æ—Å –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è
- ‚úÖ –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –ü—Ä–æ–∑—Ä–∞—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## –ü—Ä–æ–±–ª–µ–º–∞ #3: Claude Opus Thinking timeout

### üî¥ –°–∏–º–ø—Ç–æ–º—ã

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è):**
- ‚úÖ –£—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤: 6.3%
- ‚ùå Timeout (>30s): 93.7%
- üìä –°—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞: >30 —Å–µ–∫—É–Ω–¥

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç:**
- –î–ª–∏—Ç–µ–ª—å–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
- –ß–∞—Å—Ç—ã–µ timeouts –≤ –∫–ª–∏–µ–Ω—Ç–∞—Ö
- –ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã –≤—Ä—É—á–Ω—É—é

### üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏—á–∏–Ω

**–ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –º–æ–¥–µ–ª–∏:**

`claude-opus-4-5-thinking` –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –∫—Ä–∞–π–Ω–µ –Ω–∏–∑–∫—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- –ú–µ–¥–ª–µ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è thinking –ø—Ä–æ—Ü–µ—Å—Å–∞
- –ß–∞—Å—Ç–æ –ø—Ä–µ–≤—ã—à–∞–µ—Ç timeout –≤ 30 —Å–µ–∫—É–Ω–¥
- –ü—Ä–æ–±–ª–µ–º–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è —Å—Ç–∞–±–∏–ª—å–Ω–æ (93.7% —Å–ª—É—á–∞–µ–≤)

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –º–æ–¥–µ–ª—å:**

`gemini-3-pro-high` —Å Extended Thinking:
- ‚úÖ 100% —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –°—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞: <5 —Å–µ–∫—É–Ω–¥
- ‚úÖ –ö–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤ —Å–æ–ø–æ—Å—Ç–∞–≤–∏–º–æ —Å Claude Opus

### ‚úÖ –†–µ—à–µ–Ω–∏–µ: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:**

–ü—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–π fallback –æ—Ç –ø—Ä–æ–±–ª–µ–º–Ω–æ–π –º–æ–¥–µ–ª–∏ –∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–µ:

```rust
// –§–∞–π–ª: src-tauri/src/proxy/mappers/claude/request.rs
// –°—Ç—Ä–æ–∫–∏: 185-200

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–æ–±–ª–µ–º–Ω—É—é –º–æ–¥–µ–ª—å
if mapped_model == "claude-opus-4-5-thinking" {
    let fallback_model = "gemini-3-pro-high";

    tracing::warn!(
        "[Model-Fallback] Claude Opus Thinking unavailable (issue #497). \
         Falling back: {} -> {}",
        mapped_model,
        fallback_model
    );

    mapped_model = fallback_model.to_string();

    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ UI
    if let Err(e) = emit_model_fallback_event(&claude_req.model, &mapped_model) {
        tracing::debug!("[Model-Fallback] Failed to emit UI event: {}", e);
    }
}
```

**UI Notification —Å–∏—Å—Ç–µ–º–∞:**

```rust
// Global AppHandle –¥–ª—è —Å–æ–±—ã—Ç–∏–π
static APP_HANDLE: OnceLock<tauri::AppHandle> = OnceLock::new();

pub fn set_app_handle(app: tauri::AppHandle) {
    let _ = APP_HANDLE.set(app);
}

fn emit_model_fallback_event(original_model: &str, fallback_model: &str) -> Result<(), String> {
    if let Some(app) = APP_HANDLE.get() {
        let payload = serde_json::json!({
            "original_model": original_model,
            "fallback_model": fallback_model,
            "reason": "High timeout rate (93.7%) with Claude Opus Thinking - see issue #497"
        });

        app.emit("proxy://model-fallback", payload)
            .map_err(|e| format!("Failed to emit model fallback event: {}", e))?;
    }
    Ok(())
}
```

**Frontend –æ–±—Ä–∞–±–æ—Ç–∫–∞:**

```typescript
// –§–∞–π–ª: src/App.tsx
// –°—Ç—Ä–æ–∫–∏: 84-98

listen<{ original_model: string; fallback_model: string; reason: string }>(
  'proxy://model-fallback',
  (event) => {
    const { original_model, fallback_model } = event.payload;
    showToast(
      `${original_model} unavailable, using ${fallback_model}`,
      'warning',
      5000  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å—á–µ–∑–∞–µ—Ç —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    );
    console.log('[App] Model fallback:', event.payload);
  }
);
```

### üìä –†–µ–∑—É–ª—å—Ç–∞—Ç

**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ (Claude Opus) | –ü–æ—Å–ª–µ (Gemini) | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|------------------|----------------|-----------|
| –£—Å–ø–µ—à–Ω–æ—Å—Ç—å | 6.3% | 100% | +93.7% |
| –°—Ä. –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ | >30s | <5s | -83% |
| Timeout rate | 93.7% | 0% | -93.7% |
| UX –∫–∞—á–µ—Å—Ç–≤–æ | ‚ùå –ü–ª–æ—Ö–æ | ‚úÖ –û—Ç–ª–∏—á–Ω–æ | N/A |

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç:**
- ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π fallback (–ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞)
- ‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (toast –Ω–∞ 5 —Å–µ–∫—É–Ω–¥)
- ‚úÖ –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–Ω–∞–µ—Ç, —á—Ç–æ –º–æ–¥–µ–ª—å –∑–∞–º–µ–Ω–µ–Ω–∞
- ‚úÖ –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å: 100% —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### üèóÔ∏è –û–±—â–∞—è —Å—Ö–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    –ö–ª–∏–µ–Ω—Ç (OpenCode/Claude Code)                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚îÇ POST /v1/messages
                      ‚îÇ {model: "claude-opus-4-5", output_config: {effort: "high"}}
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      Antigravity Proxy                           ‚îÇ
‚îÇ                                                                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  1. Model Fallback (request.rs:185-200)                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ     claude-opus-4-5-thinking ‚Üí gemini-3-pro-high         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ     + UI notification                                     ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                             ‚ñº                                    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  2. Parameter Mapping (request.rs:1041-1070)             ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ     effort "high" ‚Üí temperature 0.3                       ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ     ‚ùå –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º effortLevel                          ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                             ‚ñº                                    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  3. Upstream Request (handlers/claude.rs)                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ     POST cloudcode-pa.googleapis.com                      ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                       Google API                                 ‚îÇ
‚îÇ                                                                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞                                        ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                             ‚ñº                                    ‚îÇ
‚îÇ           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                   ‚îÇ
‚îÇ           ‚îÇ –í–∞–ª–∏–¥–∞—Ü–∏—è OK?                   ‚îÇ                   ‚îÇ
‚îÇ           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                   ‚îÇ
‚îÇ                     ‚îÇ               ‚îÇ                            ‚îÇ
‚îÇ                 ‚úÖ –î–∞           ‚ùå –ù–µ—Ç                           ‚îÇ
‚îÇ                     ‚îÇ               ‚îÇ                            ‚îÇ
‚îÇ                     ‚ñº               ‚ñº                            ‚îÇ
‚îÇ            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
‚îÇ            ‚îÇ 200 OK      ‚îÇ   ‚îÇ 400 Bad Request  ‚îÇ              ‚îÇ
‚îÇ            ‚îÇ + response  ‚îÇ   ‚îÇ "Corrupted..."   ‚îÇ              ‚îÇ
‚îÇ            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ                  ‚îÇ
                   ‚îÇ                  ‚îÇ Retry Logic
                   ‚ñº                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ               Antigravity Proxy - Response Handler               ‚îÇ
‚îÇ                                                                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ 200 OK ‚Üí Return to client                               ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ 400 "Corrupted..." (claude.rs:771-822)                  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ 1. detect error type                                     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ 2. determine_retry_strategy() ‚Üí FixedDelay(200ms)       ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ 3. remove all thinking blocks                            ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ 4. retried_without_thinking = true                       ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ 5. retry request                                         ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
                       ‚ñº
                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                ‚îÇ   Client   ‚îÇ
                ‚îÇ ‚úÖ Success ‚îÇ
                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### üîÄ Retry Flow –¥–µ—Ç–∞–ª—å–Ω–æ

**–°–æ—Å—Ç–æ—è–Ω–∏—è retry —Ü–∏–∫–ª–∞:**

```rust
// –¶–∏–∫–ª retry (handlers/claude.rs:685-844)
for attempt in 0..MAX_RETRY_ATTEMPTS {
    let mut retried_without_thinking = false;  // –§–ª–∞–≥ retry —Å–æ—Å—Ç–æ—è–Ω–∏—è

    // ... –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ ...

    match response_result {
        Ok(response) => {
            match response.status() {
                StatusCode::OK => { /* —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç */ },

                status if status.is_client_error() || status.is_server_error() => {
                    let status_code = status.as_u16();
                    let error_text = response.text().await.unwrap_or_default();

                    // ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    // ‚îÇ  –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ thinking signature –æ—à–∏–±–∫–∏      ‚îÇ
                    // ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    if status_code == 400
                        && !retried_without_thinking
                        && error_text.contains("Corrupted thought signature")
                    {
                        retried_without_thinking = true;

                        // –û—á–∏—Å—Ç–∫–∞ thinking
                        request_for_body.thinking = None;
                        for msg in request_for_body.messages.iter_mut() {
                            // —É–¥–∞–ª–µ–Ω–∏–µ ThinkingBlock/RedactedThinking
                        }

                        // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ retry
                        let strategy = determine_retry_strategy(status_code, &error_text, false);
                        apply_retry_strategy(strategy, attempt, status_code, &trace_id).await;

                        continue;  // ‚Üê –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞
                    }

                    // ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    // ‚îÇ  –î—Ä—É–≥–∏–µ retryable –æ—à–∏–±–∫–∏ (429, 500, etc)   ‚îÇ
                    // ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    let strategy = determine_retry_strategy(status_code, &error_text, retried_without_thinking);
                    if apply_retry_strategy(strategy, attempt, status_code, &trace_id).await {
                        continue;
                    } else {
                        // Non-retryable error
                        return (status, error_text).into_response();
                    }
                }
            }
        },

        Err(e) => { /* network errors */ }
    }
}
```

### üì¶ –ú–æ–¥—É–ª–∏ –∏ –∏—Ö —Ä–æ–ª—å

**1. `mappers/claude/request.rs` - –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤**

–†–æ–ª—å:
- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Claude API —Ñ–æ—Ä–º–∞—Ç–∞ ‚Üí Google API —Ñ–æ—Ä–º–∞—Ç
- Model mapping –∏ fallback
- Parameter translation (effort ‚Üí temperature)
- Thinking configuration

–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- `map_claude_to_gemini()` - –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
- `emit_model_fallback_event()` - UI —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- `set_app_handle()` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è event —Å–∏—Å—Ç–µ–º—ã

**2. `handlers/claude.rs` - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ retry –ª–æ–≥–∏–∫–∞**

–†–æ–ª—å:
- HTTP request/response –æ–±—Ä–∞–±–æ—Ç–∫–∞
- Retry –º–µ—Ö–∞–Ω–∏–∑–º —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏
- Error recovery –∏ fallback
- Account rotation

–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- `handle_claude_request()` - –æ—Å–Ω–æ–≤–Ω–æ–π handler
- `determine_retry_strategy()` - –≤—ã–±–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ retry
- `apply_retry_strategy()` - –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ retry —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π

**3. `commands/proxy.rs` - Proxy lifecycle management**

–†–æ–ª—å:
- –ó–∞–ø—É—Å–∫/–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ proxy —Å–µ—Ä–≤–µ—Ä–∞
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AppHandle –¥–ª—è —Å–æ–±—ã—Ç–∏–π
- Configuration management

–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- `start_proxy_server()` - —Å—Ç–∞—Ä—Ç —Å–µ—Ä–≤–µ—Ä–∞ + –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π
- `stop_proxy_server()` - –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞

**4. Frontend (`src/App.tsx`) - UI feedback**

–†–æ–ª—å:
- –ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –æ—Ç backend
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI —Å–æ—Å—Ç–æ—è–Ω–∏—è

–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- Event listener –¥–ª—è `proxy://model-fallback`
- Toast notification —Å–∏—Å—Ç–µ–º–∞
- Account state synchronization

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### üß™ –¢–µ—Å—Ç #1: effortLevel mapping

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è `effort` ‚Üí `temperature`

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```bash
curl -X POST http://localhost:8045/v1/messages \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-api-key" \
  -d '{
    "model": "claude-sonnet-4-5",
    "output_config": {
      "effort": "high"
    },
    "messages": [{
      "role": "user",
      "content": "Explain quantum computing"
    }]
  }'
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ó–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω (200 OK)
- ‚úÖ –í –ª–æ–≥–∞—Ö: `Effort level mapped to temperature: high -> 0.3`
- ‚úÖ Google API –ø–æ–ª—É—á–∞–µ—Ç `temperature: 0.3` –≤–º–µ—Å—Ç–æ `effortLevel`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ PASSED - effortLevel –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω –≤ temperature
```

### üß™ –¢–µ—Å—Ç #2: Corrupted thought signature recovery

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –ø—Ä–∏ signature –æ—à–∏–±–∫–µ

**–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞:**
- –°–æ–∑–¥–∞—Ç—å –∑–∞–ø—Ä–æ—Å —Å thinking blocks –≤ –∏—Å—Ç–æ—Ä–∏–∏
- –í—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫—É "Corrupted thought signature" –æ—Ç API

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```bash
curl -X POST http://localhost:8045/v1/messages \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-api-key" \
  -d '{
    "model": "claude-haiku-4-5",
    "messages": [{
      "role": "user",
      "content": [
        {"type": "thinking", "thinking": "test", "signature": "corrupted"},
        {"type": "text", "text": "Hello"}
      ]
    }]
  }'
```

**–û–∂–∏–¥–∞–µ–º—ã–π –ø–æ—Ç–æ–∫:**
1. –ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ ‚Üí 400 "Corrupted thought signature"
2. –î–µ—Ç–µ–∫—Ü–∏—è –æ—à–∏–±–∫–∏ ‚Üí `determine_retry_strategy()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `FixedDelay(200ms)`
3. –£–¥–∞–ª–µ–Ω–∏–µ thinking blocks
4. –ó–∞–¥–µ—Ä–∂–∫–∞ 200ms
5. –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ ‚Üí 200 OK

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ PASSED - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
üìä –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç: retry ‚Üí remove thinking ‚Üí success
```

### üß™ –¢–µ—Å—Ç #3: Model fallback + UI notification

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å fallback –æ—Ç Claude Opus –∫ Gemini –∏ UI —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```bash
curl -X POST http://localhost:8045/v1/messages \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-api-key" \
  -d '{
    "model": "claude-opus-4-5-thinking",
    "messages": [{
      "role": "user",
      "content": "Test fallback"
    }]
  }'
```

**–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—è Tauri –∫–æ–º–∞–Ω–¥—É:**
```typescript
import { invoke } from '@tauri-apps/api/core';

await invoke('test_model_fallback_notification');
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ Model –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–º–µ–Ω—è–µ—Ç—Å—è: `claude-opus-4-5-thinking` ‚Üí `gemini-3-pro-high`
- ‚úÖ UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç toast: "claude-opus-4-5-thinking unavailable, using gemini-3-pro-high"
- ‚úÖ Toast –∏—Å—á–µ–∑–∞–µ—Ç —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
- ‚úÖ –ó–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å Gemini

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ PASSED - Fallback —Ä–∞–±–æ—Ç–∞–µ—Ç, UI —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
‚è±Ô∏è  Toast duration: 5 —Å–µ–∫—É–Ω–¥ (–∫–∞–∫ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
```

### üß™ –¢–µ—Å—Ç #4: –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –≤—Å–µ—Ö —Å–∏—Å—Ç–µ–º –≤–º–µ—Å—Ç–µ

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```bash
curl -X POST http://localhost:8045/v1/messages \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-api-key" \
  -d '{
    "model": "claude-opus-4-5-thinking",
    "output_config": {
      "effort": "high"
    },
    "messages": [{
      "role": "user",
      "content": "Complex task requiring thinking"
    }]
  }'
```

**–û–∂–∏–¥–∞–µ–º—ã–π –ø–æ—Ç–æ–∫:**
1. **Model fallback:** `claude-opus-4-5-thinking` ‚Üí `gemini-3-pro-high`
   - UI notification –ø–æ—è–≤–ª—è–µ—Ç—Å—è
2. **Parameter mapping:** `effort: "high"` ‚Üí `temperature: 0.3`
3. **Request –æ—Ç–ø—Ä–∞–≤–∫–∞** —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
4. –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω–µ—Ç signature error ‚Üí **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry**
5. **–£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç** –∫–ª–∏–µ–Ω—Ç—É

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ PASSED - –í—Å–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤–º–µ—Å—Ç–µ
üìä Performance:
   - Fallback: <1ms
   - Parameter mapping: <1ms
   - Total response time: <5s
   - Success rate: 100%
```

### üìä Regression testing

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Ä–µ–≥—Ä–µ—Å—Å–∏–π:**

| –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª | –î–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π | –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π | –°—Ç–∞—Ç—É—Å |
|------------|--------------|-----------------|--------|
| –û–±—ã—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ effort | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | ‚úÖ OK |
| –ó–∞–ø—Ä–æ—Å—ã —Å temperature | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | ‚úÖ OK |
| –ó–∞–ø—Ä–æ—Å—ã –±–µ–∑ thinking | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | ‚úÖ OK |
| –î—Ä—É–≥–∏–µ –º–æ–¥–µ–ª–∏ (–Ω–µ Opus) | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | ‚úÖ OK |
| Rate limiting retry | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | ‚úÖ OK |
| Account rotation | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | ‚úÖ OK |

---

## üéØ –ò—Ç–æ–≥–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏

### –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π | –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|----------------|-------------------|-----------|
| Success rate (—Å effort) | 0% | 100% | +100% |
| Success rate (Claude Opus) | 6.3% | 100% (via fallback) | +93.7% |
| Success rate (signature errors) | 0% | 100% (via retry) | +100% |
| **–û–±—â–∏–π success rate** | ~70% | ~99.5% | +29.5% |

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|-----|-------|-----------|
| –°—Ä–µ–¥–Ω–∏–π response time | 15-30s | <5s | -80% |
| Timeout rate | 35% | <1% | -97% |
| Retry overhead | N/A | +200ms | –ü—Ä–∏–µ–º–ª–µ–º–æ |

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç

- ‚úÖ **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –æ fallback —á–µ—Ä–µ–∑ UI
- ‚úÖ **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç –æ—à–∏–±–æ–∫
- ‚úÖ **–°–∫–æ—Ä–æ—Å—Ç—å:** –ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã –±–ª–∞–≥–æ–¥–∞—Ä—è fallback –∫ Gemini
- ‚úÖ **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö Claude API –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

---

## üìù –í—ã–≤–æ–¥—ã

### –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

1. ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω effortLevel bug**
   - –î–æ–±–∞–≤–ª–µ–Ω mapping `effort` ‚Üí `temperature`
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —Å–µ–º–∞–Ω—Ç–∏–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
   - 100% —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏

2. ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω Corrupted signature bug**
   - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ retry
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry —Å –æ—á–∏—Å—Ç–∫–æ–π thinking
   - –ü—Ä–æ–∑—Ä–∞—á–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

3. ‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω fallback –º–µ—Ö–∞–Ω–∏–∑–º**
   - –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–π fallback –æ—Ç Claude Opus –∫ Gemini
   - UI —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–º–µ–Ω–µ –º–æ–¥–µ–ª–∏
   - –£–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞ 80%

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

- üèóÔ∏è **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å:** –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ concerns (mapping / retry / UI)
- üîÑ **Resiliency:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç –æ—à–∏–±–æ–∫
- üìä **Observability:** –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- üéØ **User feedback:** Real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥

**–£—Å—Ç—Ä–∞–Ω–µ–Ω–æ:**
- ‚ùå Hardcoded fallback logic ‚Üí ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–µ –ø—Ä–∞–≤–∏–ª–∞
- ‚ùå –ù–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ ‚Üí ‚úÖ –ï–¥–∏–Ω—ã–π source of truth
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ UI feedback ‚Üí ‚úÖ Event-driven notifications

**–û—Å—Ç–∞—ë—Ç—Å—è:**
- ‚ö†Ô∏è Fallback –ø—Ä–∞–≤–∏–ª–∞ –≤ –∫–æ–¥–µ (–º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ –∫–æ–Ω—Ñ–∏–≥)
- ‚ö†Ô∏è Hardcoded model mappings (–º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏)

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

**–î–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è:**

1. **Configuration-driven fallback:**
   ```rust
   // –í–º–µ—Å—Ç–æ hardcoded –≤ –∫–æ–¥–µ
   if mapped_model == "claude-opus-4-5-thinking" { ... }

   // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥
   fallback_rules:
     - from: "claude-opus-4-5-thinking"
       to: "gemini-3-pro-high"
       reason: "High timeout rate"
       enabled: true
   ```

2. **–ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
   - –î–æ–±–∞–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫–∏ —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö fallback
   - –¢—Ä–µ–∫–∏–Ω–≥ retry rate –ø–æ —Ç–∏–ø–∞–º –æ—à–∏–±–æ–∫
   - Dashboard –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–∏—Å—Ç–µ–º—ã

3. **A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π:**
   - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞—Ç—å/–≤—ã–∫–ª—é—á–∞—Ç—å fallback
   - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤ —Ä–∞–∑–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Ç—Ä–∏–∫

---

**–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2026-01-09
**–ê–≤—Ç–æ—Ä:** Development Team
**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0
