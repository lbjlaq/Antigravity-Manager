# Web Server Mode å…¨æ ˆæ”¹é€ è®¡åˆ’

## ğŸ“‹ æ”¹é€ ç›®æ ‡

å°† Tauri æ¡Œé¢åº”ç”¨æ”¹é€ ä¸ºå¯åœ¨ Linux æœåŠ¡å™¨éƒ¨ç½²çš„å…¨æ ˆ Web åº”ç”¨ï¼Œæ”¯æŒ Docker å®¹å™¨åŒ–éƒ¨ç½²ã€‚

## ğŸ—ï¸ ç›®æ ‡æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    antigravity-web-server                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Axum HTTP Server (ç»Ÿä¸€å…¥å£)                            â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ /v1/chat/completions      (OpenAI åè®®ä»£ç†)        â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ /v1/messages              (Anthropic åè®®ä»£ç†)     â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ /v1/models                (æ¨¡å‹åˆ—è¡¨)               â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ /api/accounts/*           (è´¦å·ç®¡ç† REST API)      â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ /api/config               (é…ç½®ç®¡ç† API)           â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ /api/stats                (ç»Ÿè®¡ API)               â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ /api/quota/*              (é…é¢æŸ¥è¯¢ API)           â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ /health                   (å¥åº·æ£€æŸ¥)               â”‚   â”‚
â”‚  â”‚  â””â”€â”€ /*                        (é™æ€æ–‡ä»¶ - React SPA)   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†“                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ TokenManager â”‚  â”‚ OAuth æ¨¡å—   â”‚  â”‚ è´¦å· JSON æ–‡ä»¶å­˜å‚¨    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‚ æ–°å¢ç›®å½•ç»“æ„

```
antigravity-manager/
â”œâ”€â”€ server/                          # æ–°å¢ï¼šç‹¬ç«‹ Rust Web æœåŠ¡å™¨
â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ main.rs                  # å…¥å£ç‚¹
â”‚   â”‚   â”œâ”€â”€ config.rs                # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ routes/                  # API è·¯ç”±
â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ proxy.rs             # åä»£è·¯ç”± (è¿ç§»è‡ª src-tauri)
â”‚   â”‚   â”‚   â”œâ”€â”€ accounts.rs          # è´¦å·ç®¡ç† API
â”‚   â”‚   â”‚   â”œâ”€â”€ config.rs            # é…ç½® API
â”‚   â”‚   â”‚   â””â”€â”€ stats.rs             # ç»Ÿè®¡ API
â”‚   â”‚   â”œâ”€â”€ services/                # ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ account_service.rs   # è´¦å·æœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ token_manager.rs     # Token ç®¡ç† (è¿ç§»)
â”‚   â”‚   â”‚   â”œâ”€â”€ oauth.rs             # OAuth (è¿ç§»)
â”‚   â”‚   â”‚   â””â”€â”€ quota.rs             # é…é¢æŸ¥è¯¢ (è¿ç§»)
â”‚   â”‚   â”œâ”€â”€ proxy/                   # åä»£æ ¸å¿ƒ (è¿ç§»è‡ª src-tauri/proxy)
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â””â”€â”€ models/                  # æ•°æ®æ¨¡å‹ (è¿ç§»)
â”‚   â”‚       â””â”€â”€ ...
â”‚   â””â”€â”€ Dockerfile
â”œâ”€â”€ web/                             # æ–°å¢ï¼šWeb å‰ç«¯ (ä» src æ”¹é€ )
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â””â”€â”€ api.ts               # HTTP API è°ƒç”¨ (æ›¿ä»£ Tauri invoke)
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ ...
â”œâ”€â”€ docker-compose.yml               # Docker Compose é…ç½®
â”œâ”€â”€ src-tauri/                       # ä¿ç•™ï¼šåŸ Tauri ç‰ˆæœ¬
â”œâ”€â”€ src/                             # ä¿ç•™ï¼šåŸ Tauri å‰ç«¯
â””â”€â”€ ...
```

## âœ… æ”¹é€ ä»»åŠ¡æ¸…å•

### Phase 1: åç«¯æ”¹é€  (server/) âœ… åŸºç¡€å®Œæˆ

#### 1.1 åˆ›å»ºç‹¬ç«‹ Rust é¡¹ç›®
- [x] åˆ›å»º `server/` ç›®å½•
- [x] åˆå§‹åŒ– Cargo.toml
- [x] é…ç½®ä¾èµ– (axum, tokio, serde, etc.)

#### 1.2 è¿ç§»æ ¸å¿ƒæ¨¡å—
- [x] è¿ç§» `proxy/` æ¨¡å— (converter.rs, client.rs)
- [x] åˆ›å»º `models/` æ•°æ®æ¨¡å‹ (account, token, quota)
- [x] è¿ç§» OAuth åˆ·æ–°é€»è¾‘ (oauth_service.rs)
- [x] åˆ›å»º Token ç®¡ç†å™¨ (token_manager.rs)
- [x] åˆ›å»ºè´¦å·æœåŠ¡ (account_service.rs)

#### 1.3 å®ç°ç®¡ç† API âœ…
- [x] `GET /api/accounts` - åˆ—å‡ºè´¦å·
- [x] `POST /api/accounts` - æ·»åŠ è´¦å· (é€šè¿‡ refresh_token)
- [x] `DELETE /api/accounts/:id` - åˆ é™¤è´¦å·
- [x] `POST /api/accounts/:id/refresh` - åˆ·æ–°è´¦å· Token
- [x] `GET /api/accounts/:id/quota` - æŸ¥è¯¢é…é¢
- [x] `POST /api/accounts/reload` - é‡æ–°åŠ è½½è´¦å·

#### 1.4 å®ç°é…ç½® API âœ…
- [x] `GET /api/config` - è·å–é…ç½®
- [x] `PUT /api/config` - æ›´æ–°é…ç½®
- [x] `GET /api/stats` - è·å–ç»Ÿè®¡ä¿¡æ¯

#### 1.5 å®ç°åä»£è·¯ç”± âœ…
- [x] `POST /v1/chat/completions` - OpenAI åè®®
- [x] `POST /v1/messages` - Anthropic åè®®
- [x] `GET /v1/models` - æ¨¡å‹åˆ—è¡¨

#### 1.6 Docker åŒ– âœ…
- [x] ç¼–å†™ Dockerfile (å¤šé˜¶æ®µæ„å»º)
- [x] ç¼–å†™ docker-compose.yml


### Phase 2: å‰ç«¯æ”¹é€  (web/) ğŸ”„ è¿›è¡Œä¸­

#### 2.1 åˆ›å»ºç‹¬ç«‹ Web é¡¹ç›®
- [x] åˆ›å»º `web/` ç›®å½•
- [x] æ›´æ–° package.json (ç§»é™¤ Tauri ä¾èµ–)
- [x] æ›´æ–° vite.config.ts (æ·»åŠ  API ä»£ç†)
- [x] å¤åˆ¶é…ç½®æ–‡ä»¶ (tailwind, postcss, tsconfig)

#### 2.2 æ”¹é€  API è°ƒç”¨å±‚
- [x] åˆ›å»º `services/api.ts` (HTTP å®¢æˆ·ç«¯)
- [ ] å¤åˆ¶å¹¶æ”¹é€ é¡µé¢ç»„ä»¶
- [ ] æ›¿æ¢æ‰€æœ‰ `invoke()` è°ƒç”¨
- [ ] å¤„ç†è®¤è¯ (API Key header)

#### 2.3 ç§»é™¤ Tauri ç‰¹æœ‰åŠŸèƒ½
- [ ] ç§»é™¤ç³»ç»Ÿæ‰˜ç›˜ç›¸å…³ä»£ç 
- [ ] ç§»é™¤çª—å£æ§åˆ¶ä»£ç 
- [ ] ç§»é™¤æ–‡ä»¶ç³»ç»Ÿç›´æ¥è®¿é—®

#### 2.4 é€‚é… Web ç¯å¢ƒ
- [ ] ç§»é™¤ OAuth ç™»å½•æµç¨‹ (æ”¹ä¸ºä»…æ”¯æŒ refresh_token)
- [ ] è°ƒæ•´é…ç½®æŒä¹…åŒ– (localStorage)


### Phase 3: é›†æˆæµ‹è¯•

- [ ] æœ¬åœ°å¼€å‘æµ‹è¯•
- [ ] Docker æ„å»ºæµ‹è¯•
- [ ] API åŠŸèƒ½æµ‹è¯•
- [ ] å‰ç«¯åŠŸèƒ½æµ‹è¯•


## ğŸ”§ å…³é”®ä»£ç æ”¹é€ ç‚¹

### åç«¯ï¼šTauri Command â†’ HTTP API

```rust
// åŸ Tauri Command
#[tauri::command]
fn list_accounts() -> Result<Vec<Account>, String> {
    modules::account::list_accounts()
}

// æ–° Axum Handler
async fn list_accounts(
    State(state): State<AppState>,
) -> Result<Json<Vec<Account>>, AppError> {
    let accounts = state.account_service.list_accounts()?;
    Ok(Json(accounts))
}
```

### å‰ç«¯ï¼šTauri invoke â†’ HTTP fetch

```typescript
// æ—§ä»£ç  (Tauri)
import { invoke } from '@tauri-apps/api/core';
const accounts = await invoke<Account[]>('list_accounts');

// æ–°ä»£ç  (HTTP)
import { api } from '@/services/api';
const accounts = await api.accounts.list();
```

## ğŸ“ é…ç½®æ–‡ä»¶æ ¼å¼

### config.json
```json
{
  "server": {
    "port": 8045,
    "host": "0.0.0.0"
  },
  "proxy": {
    "api_key": "sk-antigravity",
    "request_timeout": 120,
    "upstream_proxy": null
  },
  "accounts_dir": "./data/accounts"
}
```

### ç¯å¢ƒå˜é‡
```bash
ANTIGRAVITY_PORT=8045
ANTIGRAVITY_HOST=0.0.0.0
ANTIGRAVITY_API_KEY=sk-antigravity
ANTIGRAVITY_ACCOUNTS_DIR=/data/accounts
ANTIGRAVITY_UPSTREAM_PROXY=socks5://127.0.0.1:1080
```

## ğŸš€ éƒ¨ç½²æ–¹å¼

### Docker å•å®¹å™¨
```bash
docker build -t antigravity-web .
docker run -d -p 8045:8045 -v ./data:/data antigravity-web
```

### Docker Compose
```bash
docker-compose up -d
```

## ğŸ“… é¢„è®¡æ—¶é—´

| Phase | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ |
|-------|------|----------|
| 1 | åç«¯æ”¹é€  | 3-4 å¤© |
| 2 | å‰ç«¯æ”¹é€  | 2-3 å¤© |
| 3 | é›†æˆæµ‹è¯• | 1 å¤© |
| **æ€»è®¡** | | **6-8 å¤©** |

---

*åˆ›å»ºæ—¶é—´: 2025-12-24*
*åˆ†æ”¯: feature/web-server-mode*
